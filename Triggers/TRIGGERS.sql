--------------------------------------------------------- TRIGGERS ---------------------------------------

CREATE TABLE PRODUCT
(
PID CHAR(5),
PDESC VARCHAR(40),
PRICE INT
);

CREATE TABLE STOCK
(
PID CHAR(5),
SQTY INT
);

CREATE TABLE ORDERS
(
OID CHAR(5),
CID CHAR(5),
PID CHAR(5),
QTY INT
);

INSERT INTO PRODUCT VALUES ('P0001', 'DELL MOUSE', 550);
INSERT INTO PRODUCT VALUES ('P0002', 'HP WIRELESS KEYBOARD', 950);
INSERT INTO PRODUCT VALUES ('P0003', 'UPS 650VA', 2450);
INSERT INTO PRODUCT VALUES ('P0004', 'SAMSUNG 22" MONITOR', 6500);
INSERT INTO PRODUCT VALUES ('P0005', 'DELL I5 LAPTOP', 35500);


INSERT INTO STOCK VALUES('P0001', 200);
INSERT INTO STOCK VALUES('P0002', 100);
INSERT INTO STOCK VALUES('P0003', 100);
INSERT INTO STOCK VALUES('P0004', 50);
INSERT INTO STOCK VALUES('P0005', 50);

SELECT * FROM PRODUCT;
SELECT * FROM STOCK;

INSERT INTO ORDERS VALUES('O0001', 'C0001', 'P0001', 20);

SELECT * FROM ORDERS;
SELECT * FROM STOCK;

CREATE TRIGGER TR_ORD 
ON ORDERS
FOR INSERT
AS
BEGIN
	
	SET NOCOUNT ON;
	UPDATE STOCK
	SET SQTY = SQTY - (SELECT QTY FROM INSERTED)
	WHERE PID = (SELECT PID FROM INSERTED);

END;

INSERT INTO ORDERS VALUES('O0002', 'C0002', 'P0001', 10);

INSERT INTO ORDERS VALUES('O0003', 'C0002', 'P0001', 20);

INSERT INTO ORDERS VALUES('O0003', 'C0003', 'P0002', 20);


select * FROM PRODUCT;
SELECT * FROM STOCK;


CREATE TRIGGER TR_DEL_PROD
ON PRODUCT
FOR DELETE
AS
BEGIN
	
	DELETE FROM STOCK
	WHERE PID = (SELECT PID FROM DELETED)

END;

DELETE FROM PRODUCT 
WHERE PID = 'P0002';


INSERT INTO ORDERS VALUES('O0004', 'C0004', 'P0004', 20);

UPDATE ORDERS
SET QTY = 30
WHERE OID = 'O0004';


------------ NOW WE NEED UPDATE TRIGGER -------------------------------------------------------------------------------------------------------------------

CREATE TRIGGER TR_UPD_STO
ON ORDERS
FOR UPDATE
AS
BEGIN
	
	DECLARE @OQ AS INT;
	DECLARE @NQ AS INT;

	SET @OQ = (SELECT QTY FROM DELETED)
	SET @NQ = (SELECT QTY FROM INSERTED)

	UPDATE STOCK
	SET SQTY = SQTY + @OQ - @NQ
	WHERE PID = (SELECT PID FROM INSERTED);
END;


INSERT INTO ORDERS VALUES('O0005', 'C0004', 'P0004', 20);

UPDATE ORDERS
SET QTY = 25
WHERE OID = 'O0005';


--------------------------------------------------------------------------------------

INSERT INTO ORDERS VALUES('O0006', 'C0003', 'P0004', 15);

SELECT * FROM ORDERS;
SELECT * FROM STOCK;



------------------------------------------------------------------------------------------------------------------------------------------

DROP TRIGGER TR_IN_ORD;

CREATE TRIGGER TR_IN_ORD
ON ORDERS
FOR INSERT
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @QR AS INT;
	DECLARE @QS AS INT;

	SET @QR = (SELECT QTY FROM INSERTED);
	SET @QS = (SELECT SQTY FROM STOCK WHERE PID = (SELECT PID FROM INSERTED));

	IF @QS >= @QR
		BEGIN
			UPDATE STOCK 
			SET SQTY = @QS - @QR
			WHERE PID = (SELECT PID FROM INSERTED);
			PRINT ('ORDER ACCEPTED');
		END;
	ELSE
		BEGIN
			ROLLBACK;
			PRINT('INSUFFICIENT QUANTITY - ORDER REJECTED');
		END;
END;



SELECT * FROM STOCK;

INSERT INTO ORDERS VALUES('O0008', 'C0005', 'P0003', 30);

SELECT * FROM ORDERS;
SELECT * FROM STOCK;

UPDATE ORDERS
SET QTY = 40
WHERE OID = 'O0008';

INSERT INTO ORDERS VALUES('O0009', 'C0002', 'P0003', 10);

INSERT INTO ORDERS VALUES('O0010', 'C0006', 'P0003', 15);



DROP TRIGGER TR_UPD_STO;

CREATE TRIGGER TR_UPD_STO           --------------------- UPDATE TRIGGER ORIG ---------------------------------
ON ORDERS
FOR UPDATE
AS
BEGIN
	
	DECLARE @OQ AS INT
	DECLARE @NQ AS INT
	DECLARE @DIF AS INT
	DECLARE @CQ AS INT

	SET @OQ = (SELECT QTY FROM deleted WHERE PID = (SELECT PID FROM INSERTED));
	SET @NQ = (SELECT QTY FROM inserted WHERE PID = (SELECT PID FROM INSERTED));
	SET @DIF = -1*(@OQ - @NQ)
	SET @CQ = (SELECT SQTY FROM STOCK WHERE PID = (SELECT PID FROM deleted));


	IF @CQ - @DIF >0
	BEGIN
		UPDATE STOCK 
		SET SQTY = SQTY - @DIF
		WHERE PID = (SELECT PID FROM INSERTED)
		PRINT('TRANSACTION UPDATES WITH NEW VALUE')
	END;

	ELSE
	BEGIN
		ROLLBACK;
		PRINT('UNABLE TO UPDATE - INSUFFICIENT BALANCE');
	END;

END;




SELECT * FROM STOCK
SELECT * FROM ORDERS;

INSERT INTO ORDERS VALUES('O0012', 'C0001', 'P0001', 20);

UPDATE ORDERS
SET QTY = 40
WHERE OID = 'O0012';


UPDATE ORDERS
SET QTY = 10
WHERE OID  = 'O0014';

INSERT INTO ORDERS VALUES('O0015', 'C0003', 'P0005', 5);

UPDATE ORDERS
SET QTY = 122
WHERE OID  = 'O0015';

INSERT INTO ORDERS VALUES('O0017', 'C0002', 'P0001', 2);

